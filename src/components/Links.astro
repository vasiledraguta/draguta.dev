<script>
  import { animate } from 'motion';

  const animateTextChange = async (
    element: HTMLElement,
    newText: string
  ): Promise<void> => {
    await animate(element, { opacity: 0, filter: 'blur(4px)' } as any, {
      duration: 0.15,
      ease: 'easeOut',
    }).finished;

    element.textContent = newText;

    await animate(element, { opacity: 1, filter: 'blur(0px)' } as any, {
      duration: 0.15,
      ease: 'easeOut',
    }).finished;
  };

  function initCopyEmail() {
    const copyButton = document.getElementById(
      'copy-email'
    ) as HTMLButtonElement | null;

    if (!copyButton || copyButton.dataset.initialized) return;
    copyButton.dataset.initialized = 'true';

    copyButton.addEventListener('click', async () => {
      if (copyButton.disabled) return;

      const email = copyButton.getAttribute('data-email');
      const originalText = copyButton.textContent || '';

      if (email) {
        try {
          if (navigator.clipboard && navigator.clipboard.writeText) {
            await navigator.clipboard.writeText(email);
          } else {
            const textArea = document.createElement('textarea');
            textArea.value = email;
            textArea.style.position = 'fixed';
            textArea.style.left = '-9999px';
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
          }

          copyButton.disabled = true;
          await animateTextChange(copyButton, 'copied!');

          const statusEl = document.getElementById('copy-status');
          if (statusEl)
            statusEl.textContent = 'Email address copied to clipboard';

          setTimeout(async () => {
            await animateTextChange(copyButton, originalText);
            copyButton.disabled = false;
            if (statusEl) statusEl.textContent = '';
          }, 1200);
        } catch (err) {
          console.error('Failed to copy email:', err);
        }
      }
    });
  }

  initCopyEmail();
  document.addEventListener('astro:page-load', initCopyEmail);
</script>

<nav class='links-nav flex flex-row items-center gap-3 text-sm'>
  <a
    class='link-item px-2 py-1 -mx-2 -my-1'
    href='https://x.com/vasiledraguta'
    target='_blank'
    rel='noopener noreferrer'
  >
    x<span class='sr-only'> (opens in new tab)</span>
  </a>
  <span class='opacity-40 pointer-events-none' aria-hidden='true'>//</span>
  <a
    class='link-item'
    href='https://github.com/vasile-draguta'
    target='_blank'
    rel='noopener noreferrer'
  >
    github<span class='sr-only'> (opens in new tab)</span>
  </a>
  <span class='opacity-40 pointer-events-none' aria-hidden='true'>//</span>
  <button
    id='copy-email'
    class='link-item cursor-pointer'
    data-email='hello@draguta.dev'
    aria-label='Copy email address hello@draguta.dev'
  >
    hello@draguta.dev
  </button>
  <span id='copy-status' class='sr-only' aria-live='polite'></span>
</nav>

<style>
  .link-item {
    color: var(--color-foreground);
    transition: color 0.2s;
  }

  .links-nav:has(.link-item:hover) .link-item:not(:hover) {
    color: var(--color-muted);
  }
</style>
